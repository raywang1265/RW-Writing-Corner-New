name: keep-supabase-awake

on:
  schedule:
    # Twice a week: Monday & Thursday at 14:00 UTC
    - cron: "0 14 * * MON,THU"
  workflow_dispatch: {}   # lets you run it manually for testing
  push:
    paths:
      - .github/workflows/keep-supabase-awake.yml

jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Curl Auth health endpoint
        env:
          PROJECT_REF: wzpdrkdzagkmihjgeirj
          ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          set -euo pipefail
          URL="https://${PROJECT_REF}.supabase.co/auth/v1/health"

          # Do a small, safe request with retries. --fail makes non-2xx exit nonzero.
          # We also send a User-Agent so it's easy to spot in logs.
          curl --silent --show-error --fail "$URL" \
            -H "apikey: ${ANON_KEY}" \
            -H "User-Agent: github-actions-keepalive" \
            --retry 4 --retry-all-errors --max-time 20 --connect-timeout 5 \
            -w "\nHTTP %{http_code}\n"

          echo "Ping succeeded"
